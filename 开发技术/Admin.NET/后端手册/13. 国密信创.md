æç¤º

å®Œç¾é€‚é…å›½äº§åŒ–è½¯ç¡¬ä»¶ç¯å¢ƒï¼Œæ”¯æŒå›½äº§ä¸­é—´ä»¶ã€å›½äº§æ•°æ®åº“ã€éº’éºŸæ“ä½œç³»ç»Ÿã€Windowsã€Linuxéƒ¨ç½²ä½¿ç”¨ï¼›é›†æˆå›½å¯†åŠ è§£å¯†æ’ä»¶ï¼Œä½¿ç”¨SM2ã€SM3ã€SM4ç­‰å›½å¯†ç®—æ³•è¿›è¡Œç­¾åã€æ•°æ®å®Œæ•´æ€§ä¿æŠ¤ï¼›è½¯ä»¶å±‚é¢å…¨é¢éµå¾ªç­‰çº§ä¿æŠ¤æµ‹è¯„è¦æ±‚ï¼Œå®Œå…¨ç¬¦åˆç­‰ä¿ã€å¯†è¯„è¦æ±‚ã€‚

æç¤º

Admin.NET å¯†ç ç›¸å…³é»˜è®¤å¼€å¯SM2å›½å¯†åŠ å¯†ä¼ è¾“å’Œå­˜å‚¨ã€‚MD5ã€SM2ã€SM4 ä»»æ„åˆ‡æ¢ã€‚

æœ‰è®¡åˆ’æ¢æ‰ MD5 å¯†ç åŠ å¯†ï¼Œé‡‡ç”¨ PBKDF2 åŠ å¯†ã€‚

var pbkdf2Hash = PBKDF2Encryption.Encrypt("Admin.NET"); // åŠ å¯†

PBKDF2Encryption.Compare("Admin.NET", pbkdf2Hash); // æ¯”è¾ƒ

```
  "Cryptogram": {
    "StrongPassword": false, // æ˜¯å¦å¼€å¯å¯†ç å¼ºåº¦éªŒè¯
    "PasswordStrengthValidation": "(?=^.{6,16}$)(?=.*\\d)(?=.*\\W+)(?=.*[A-Z])(?=.*[a-z])(?!.*\\n).*$", // å¯†ç å¼ºåº¦éªŒè¯æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¿…é¡»é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦çš„ç»„åˆï¼Œé•¿åº¦åœ¨6-16ä¹‹é—´
    "PasswordStrengthValidationMsg": "å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦çš„ç»„åˆï¼Œé•¿åº¦åœ¨6-16ä¹‹é—´", // å¯†ç å¼ºåº¦éªŒè¯æ¶ˆæ¯æç¤º
    "CryptoType": "SM2", // å¯†ç åŠ å¯†ç®—æ³•ï¼šMD5ã€SM2ã€SM4
    "PublicKey": "0484C7466D950E120E5ECE5DD85D0C90EAA85081A3A2BD7C57AE6DC822EFCCBD66620C67B0103FC8DD280E36C3B282977B722AAEC3C56518EDCEBAFB72C5A05312", // å…¬é’¥
    "PrivateKey": "8EDB615B1D48B8BE188FC0F18EC08A41DF50EA731FA28BF409E6552809E3A111" // ç§é’¥
  }
```

ç³»ç»Ÿå·²ç»å°è£… SM2ã€SM3ã€SM4 å›½å¯†ç®—æ³•ï¼Œå…·ä½“è°ƒç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

1ã€GMUtil.SM2Encrypt() è¿›è¡ŒSM2åŠ å¯†

2ã€GMUtil.SM2Decrypt() è¿›è¡ŒSM2è§£å¯†

3ã€GMUtil.SM4EncryptECB() è¿›è¡ŒSM4åŠ å¯†ï¼ˆECBï¼‰

4ã€GMUtil.SM4DecryptECB() è¿›è¡ŒSM4è§£å¯†ï¼ˆECBï¼‰

5ã€GMUtil.SM4EncryptCBC() è¿›è¡ŒSM4åŠ å¯†ï¼ˆCBCï¼‰

6ã€GMUtil.SM4DecryptCBC() è¿›è¡ŒSM4è§£å¯†ï¼ˆCBCï¼‰

å…·ä½“å®ç°ç±» [Admin.NET.Core/Util/GM/GMUtil.cs](https://gitee.com/zuohuaijun/Admin.NET/blob/next/Admin.NET/Admin.NET.Core/Util/GM/GMUtil.cs)

```
/// <summary>
/// GMå·¥å…·ç±»
/// </summary>
public class GMUtil
{
    /// <summary>
    /// SM2åŠ å¯†
    /// </summary>
    /// <param name="publicKeyHex"></param>
    /// <param name="data_string"></param>
    /// <returns></returns>
    public static string SM2Encrypt(string publicKeyHex, string data_string)
    {
        // å¦‚æœæ˜¯130ä½å…¬é’¥ï¼Œ.NETä½¿ç”¨çš„è¯ï¼ŒæŠŠå¼€å¤´çš„04æˆªå–æ‰
        if (publicKeyHex.Length == 130)
        {
            publicKeyHex = publicKeyHex.Substring(2, 128);
        }
        // å…¬é’¥Xï¼Œå‰64ä½
        string x = publicKeyHex.Substring(0, 64);
        // å…¬é’¥Yï¼Œå64ä½
        string y = publicKeyHex.Substring(64);
        // è·å–å…¬é’¥å¯¹è±¡
        AsymmetricKeyParameter publicKey1 = GM.GetPublickeyFromXY(new BigInteger(x, 16), new BigInteger(y, 16));
        // Sm2Encrypt: C1C3C2
        // Sm2EncryptOld: C1C2C3
        byte[] digestByte = GM.Sm2Encrypt(Encoding.UTF8.GetBytes(data_string), publicKey1);
        string strSM2 = Hex.ToHexString(digestByte);
        return strSM2;
    }

    /// <summary>
    /// SM2è§£å¯†
    /// </summary>
    /// <param name="privateKey_string"></param>
    /// <param name="encryptedData_string"></param>
    /// <returns></returns>
    public static string SM2Decrypt(string privateKey_string, string encryptedData_string)
    {
        if (!encryptedData_string.StartsWith("04"))
            encryptedData_string = "04" + encryptedData_string;
        BigInteger d = new(privateKey_string, 16);
        // å…ˆæ‹¿åˆ°ç§é’¥å¯¹è±¡ï¼Œç”¨ECPrivateKeyParameters æˆ– AsymmetricKeyParameter éƒ½å¯ä»¥
        // ECPrivateKeyParameters bcecPrivateKey = GmUtil.GetPrivatekeyFromD(d);
        AsymmetricKeyParameter bcecPrivateKey = GM.GetPrivatekeyFromD(d);
        byte[] byToDecrypt = Hex.Decode(encryptedData_string);
        byte[] byDecrypted = GM.Sm2Decrypt(byToDecrypt, bcecPrivateKey);
        string strDecrypted = Encoding.UTF8.GetString(byDecrypted);
        return strDecrypted;
    }

    /// <summary>
    /// SM4åŠ å¯†ï¼ˆECBï¼‰
    /// </summary>
    /// <param name="key_string"></param>
    /// <param name="plainText"></param>
    /// <returns></returns>
    public static string SM4EncryptECB(string key_string, string plainText)
    {
        byte[] key = Hex.Decode(key_string);
        byte[] bs = GM.Sm4EncryptECB(key, Encoding.UTF8.GetBytes(plainText), GM.SM4_ECB_PKCS7PADDING);//NoPadding çš„æƒ…å†µä¸‹éœ€è¦æ ¡éªŒæ•°æ®é•¿åº¦æ˜¯16çš„å€æ•°. ä½¿ç”¨ HandleSm4Padding å¤„ç†
        return Hex.ToHexString(bs);
    }

    /// <summary>
    /// SM4è§£å¯†ï¼ˆECBï¼‰
    /// </summary>
    /// <param name="key_string"></param>
    /// <param name="cipherText"></param>
    /// <returns></returns>
    public static string SM4DecryptECB(string key_string, string cipherText)
    {
        byte[] key = Hex.Decode(key_string);
        byte[] bs = GM.Sm4DecryptECB(key, Hex.Decode(cipherText), GM.SM4_ECB_PKCS7PADDING);
        return Encoding.UTF8.GetString(bs);
    }

    /// <summary>
    /// SM4åŠ å¯†ï¼ˆCBCï¼‰
    /// </summary>
    /// <param name="key_string"></param>
    /// <param name="iv_string"></param>
    /// <param name="plainText"></param>
    /// <returns></returns>
    public static string SM4EncryptCBC(string key_string, string iv_string, string plainText)
    {
        byte[] key = Hex.Decode(key_string);
        byte[] iv = Hex.Decode(iv_string);
        byte[] bs = GM.Sm4EncryptCBC(key, Encoding.UTF8.GetBytes(plainText), iv, GM.SM4_CBC_PKCS7PADDING);
        return Hex.ToHexString(bs);
    }

    /// <summary>
    /// SM4è§£å¯†ï¼ˆCBCï¼‰
    /// </summary>
    /// <param name="key_string"></param>
    /// <param name="iv_string"></param>
    /// <param name="cipherText"></param>
    /// <returns></returns>
    public static string SM4DecryptCBC(string key_string, string iv_string, string cipherText)
    {
        byte[] key = Hex.Decode(key_string);
        byte[] iv = Hex.Decode(iv_string);
        byte[] bs = GM.Sm4DecryptCBC(key, Hex.Decode(cipherText), iv, GM.SM4_CBC_PKCS7PADDING);
        return Encoding.UTF8.GetString(bs);
    }

    /// <summary>
    /// è¡¥è¶³ 16 è¿›åˆ¶å­—ç¬¦ä¸²çš„ 0 å­—ç¬¦ï¼Œè¿”å›ä¸å¸¦ 0x çš„16è¿›åˆ¶å­—ç¬¦ä¸²
    /// </summary>
    /// <param name="input"></param>
    /// <param name="mode">1è¡¨ç¤ºåŠ å¯†ï¼Œ0è¡¨ç¤ºè§£å¯†</param>
    /// <returns></returns>
    private static byte[] HandleSm4Padding(byte[] input, int mode)
    {
        if (input == null)
        {
            return null;
        }
        byte[] ret = (byte[])null;
        if (mode == 1)
        {
            int p = 16 - input.Length % 16;
            ret = new byte[input.Length + p];
            Array.Copy(input, 0, ret, 0, input.Length);
            for (int i = 0; i < p; i++)
            {
                ret[input.Length + i] = (byte)p;
            }
        }
        else
        {
            int p = input[input.Length - 1];
            ret = new byte[input.Length - p];
            Array.Copy(input, 0, ret, 0, input.Length - p);
        }
        return ret;
    }
}
```

ç³»ç»Ÿå†…ç½®äº†è·å–å›½å¯†å…¬é’¥ç§é’¥å¯¹å®ç°å’Œæ¥å£ [Admin.NET.Core/Service/Common/SysCommonService.cs](https://gitee.com/zuohuaijun/Admin.NET/blob/next/Admin.NET/Admin.NET.Core/Service/Common/SysCommonService.cs)ï¼Œä¿è¯å…¬åŒ™å‰åç«¯ä¸€è‡´æ‰è¡Œã€‚æ¥å£åœ°å€ `/api/sysCommon/smKeyPair`

```
    /// <summary>
    /// è·å–å›½å¯†å…¬é’¥ç§é’¥å¯¹ ğŸ†
    /// </summary>
    /// <returns></returns>
    [DisplayName("è·å–å›½å¯†å…¬é’¥ç§é’¥å¯¹")]
    public SmKeyPairOutput GetSmKeyPair()
    {
        var kp = GM.GenerateKeyPair();
        var privateKey = Hex.ToHexString(((ECPrivateKeyParameters)kp.Private).D.ToByteArray()).ToUpper();
        var publicKey = Hex.ToHexString(((ECPublicKeyParameters)kp.Public).Q.GetEncoded()).ToUpper();

        return new SmKeyPairOutput
        {
            PrivateKey = privateKey,
            PublicKey = publicKey,
        };
    }
```

å‰ç«¯å…¬åŒ™è·¯å¾„åœ¨ [Web/.env](https://gitee.com/zuohuaijun/Admin.NET/blob/next/Web/.env)ã€‚

```
# port ç«¯å£å·
VITE_PORT = 8888

# open è¿è¡Œ npm run dev æ—¶è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
VITE_OPEN = false

# æ‰“åŒ…æ˜¯å¦å¼€å¯ cdnï¼ˆæºæ–‡ä»¶ utils/build.tsï¼‰ï¼Œå¯è‡ªè¡Œä¿®æ”¹
VITE_OPEN_CDN = false

# public path é…ç½®çº¿ä¸Šç¯å¢ƒè·¯å¾„ï¼ˆæ‰“åŒ…ï¼‰ã€æœ¬åœ°é€šè¿‡ http-server è®¿é—®æ—¶ï¼Œè¯·ç½®ç©ºå³å¯
VITE_PUBLIC_PATH =

# SMå…¬é’¥
VITE_SM_PUBLIC_KEY = "0484C7466D950E120E5ECE5DD85D0C90EAA85081A3A2BD7C57AE6DC822EFCCBD66620C67B0103FC8DD280E36C3B282977B722AAEC3C56518EDCEBAFB72C5A05312"
```

å‰ç«¯å¯†ç åŠ å¯†ä¼ è¾“åº”ç”¨ï¼š[Web/src/views/login/component/account.vue](https://gitee.com/zuohuaijun/Admin.NET/blob/next/Web/src/views/login/component/account.vue#L187)

```
   // SM2åŠ å¯†å¯†ç 
   // const keys = SM2.generateKeyPair(); // ç”Ÿæˆå¯†åŒ™å¯¹
   const publicKey = window.__env__.VITE_SM_PUBLIC_KEY;
   const password = sm2.doEncrypt(state.ruleForm.password, publicKey, 1);
```