æç¤º

é‚®ä»¶å¤„ç†é‡‡ç”¨ [MailKit](https://github.com/jstedfast/MailKit) ç»„ä»¶æ¡†æ¶ã€‚MailKit æ˜¯ä¸€ä¸ªå¼€æºçš„ C# é‚®ä»¶å¤„ç†åº“ï¼Œç”¨äºåœ¨åº”ç”¨ç¨‹åºä¸­å‘é€å’Œæ¥æ”¶ç”µå­é‚®ä»¶ã€‚å®ƒæä¾›äº†ä¸€ä¸ªå¼ºå¤§ä¸”æ˜“äºä½¿ç”¨çš„ APIï¼Œæ”¯æŒå¤šç§é‚®ä»¶åè®®ï¼ŒåŒ…æ‹¬ SMTPã€POP3ã€å’Œ IMAPã€‚

## [SMTPåè®®](https://adminnet.top/frontendbook/introduce.html#smtp%E5%8D%8F%E8%AE%AE)

SMTPæ˜¯ä¸€ç§æä¾›å¯é ä¸”æœ‰æ•ˆçš„ç”µå­é‚®ä»¶ä¼ è¾“çš„åè®®ã€‚SMTPæ˜¯å»ºç«‹åœ¨FTPæ–‡ä»¶ä¼ è¾“æœåŠ¡ä¸Šçš„ä¸€ç§é‚®ä»¶æœåŠ¡ï¼Œä¸»è¦ç”¨äºç³»ç»Ÿä¹‹é—´çš„é‚®ä»¶ä¿¡æ¯ä¼ é€’ï¼Œå¹¶æä¾›æœ‰å…³æ¥ä¿¡çš„é€šçŸ¥ã€‚SMTPç‹¬ç«‹äºç‰¹å®šçš„ä¼ è¾“å­ç³»ç»Ÿï¼Œä¸”åªéœ€è¦å¯é æœ‰åºçš„æ•°æ®æµä¿¡é“æ”¯æŒï¼ŒSMTPçš„é‡è¦ç‰¹æ€§ä¹‹ä¸€æ˜¯å…¶èƒ½è·¨è¶Šç½‘ç»œä¼ è¾“é‚®ä»¶ï¼Œå³â€œSMTPé‚®ä»¶ä¸­ç»§â€ã€‚ä½¿ç”¨SMTPï¼Œå¯å®ç°ç›¸åŒç½‘ç»œå¤„ç†è¿›ç¨‹ä¹‹é—´çš„é‚®ä»¶ä¼ è¾“ï¼Œä¹Ÿå¯é€šè¿‡ä¸­ç»§å™¨æˆ–ç½‘å…³å®ç°æŸå¤„ç†è¿›ç¨‹ä¸å…¶ä»–ç½‘ç»œä¹‹é—´çš„é‚®ä»¶ä¼ è¾“ã€‚

ç‰¹æ€§ä¸ä¼˜åŠ¿ æè¿° å¤šåè®®æ”¯æŒ æ”¯æŒ SMTPã€POP3ã€IMAP ç­‰å¤šç§é‚®ä»¶åè®®ã€‚ å¼‚æ­¥æ“ä½œ ä½¿ç”¨å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ï¼Œæé«˜æ€§èƒ½å’Œå“åº”æ€§ã€‚ é™„ä»¶å¤„ç† æä¾›çµæ´»çš„é™„ä»¶å¤„ç†åŠŸèƒ½ï¼Œæ”¯æŒæ·»åŠ ã€è¯»å–å’Œä¿å­˜é‚®ä»¶é™„ä»¶ã€‚ SSL/TLS æ”¯æŒ æ”¯æŒå®‰å…¨å¥—æ¥å­—å±‚ï¼ˆSSLï¼‰å’Œä¼ è¾“å±‚å®‰å…¨æ€§ï¼ˆTLSï¼‰ï¼Œç¡®ä¿é‚®ä»¶çš„å®‰å…¨ä¼ è¾“ã€‚ å®¹é”™å¤„ç† æä¾›å®¹é”™å¤„ç†æœºåˆ¶ï¼Œå¤„ç†ç½‘ç»œæˆ–åè®®é”™è¯¯ï¼Œç¡®ä¿ç¨³å®šçš„é‚®ä»¶é€šä¿¡ã€‚ ä¸°å¯Œçš„ API æä¾›ä¸°å¯Œçš„ APIï¼Œæ–¹ä¾¿å¼€å‘äººå‘˜è®¿é—®é‚®ä»¶çš„å„ä¸ªæ–¹é¢ï¼ŒåŒ…æ‹¬ä¸»é¢˜ã€å‘ä»¶äººã€æ”¶ä»¶äººç­‰ã€‚ è·¨å¹³å° MailKit æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„é‚®ä»¶å¤„ç†åº“ï¼Œå¯åœ¨å¤šä¸ªæ“ä½œç³»ç»Ÿä¸Šè¿è¡Œï¼ŒåŒ…æ‹¬ Windowsã€Linux å’Œ macOSã€‚

| é‚®ç®±ç±»å‹ | POP3æœåŠ¡å™¨ | SMTPæœåŠ¡å™¨ |
| --- | --- | --- |
| ã€QQé‚®ç®±ã€‘ | pop.qq.comï¼ˆç«¯å£ï¼š110ï¼‰ | smtp.qq.comï¼ˆç«¯å£ï¼š25ï¼‰ |
| ã€sina.comã€‘ | pop3.sina.com.cnï¼ˆç«¯å£ï¼š110ï¼‰ | smtp.sina.com.cnï¼ˆç«¯å£ï¼š25ï¼‰ |
| ã€sinaVIPã€‘ | pop3.vip.sina.com ï¼ˆç«¯å£ï¼š110ï¼‰ | smtp.vip.sina.com ï¼ˆç«¯å£ï¼š25ï¼‰ |
| ã€sohu.comã€‘ | pop3.sohu.comï¼ˆç«¯å£ï¼š110ï¼‰ | smtp.sohu.comï¼ˆç«¯å£ï¼š25ï¼‰ |
| ã€126é‚®ç®±ã€‘ | pop.126.comï¼ˆç«¯å£ï¼š110ï¼‰ | smtp.126.comï¼ˆç«¯å£ï¼š25ï¼‰ |
| ã€139é‚®ç®±ã€‘ | POP.139.comï¼ˆç«¯å£ï¼š110ï¼‰ | SMTP.139.com(ç«¯å£ï¼š25) |
| ã€163.comã€‘ | pop.163.comï¼ˆç«¯å£ï¼š110ï¼‰ | smtp.163.comï¼ˆç«¯å£ï¼š25ï¼‰ |
| ã€QQä¼ä¸šé‚®ç®±ã€‘ | pop.exmail.qq.comï¼ˆSSLå¯ç”¨ ç«¯å£ï¼š995ï¼‰ | smtp.exmail.qq.comï¼ˆSSLå¯ç”¨ ç«¯å£ï¼š587/465ï¼‰ |
| ã€yahoo.comã€‘ | pop.mail.yahoo.com | smtp.mail.yahoo.com |
| ã€yahoo.com.cnã€‘ | pop.mail.yahoo.com.cnï¼ˆç«¯å£ï¼š995ï¼‰ | smtp.mail.yahoo.com.cnï¼ˆç«¯å£ï¼š587ï¼‰ |
| ã€HotMailã€‘ | pop3.live.comï¼ˆç«¯å£ï¼š995ï¼‰ | smtp.live.comï¼ˆç«¯å£ï¼š587ï¼‰ |
| ã€ Gmailã€‘ | pop.gmail.comï¼ˆSSLå¯ç”¨ç«¯å£ï¼š995ï¼‰ | smtp.gmail.comï¼ˆSSLå¯ç”¨ ç«¯å£ï¼š587ï¼‰ |
| ã€263.netã€‘ | pop3.263.netï¼ˆç«¯å£ï¼š110ï¼‰ | smtp.263.netï¼ˆç«¯å£ï¼š25ï¼‰ |
| ã€263.net.cnã€‘ | pop.263.net.cnï¼ˆç«¯å£ï¼š110ï¼‰ | smtp.263.net.cnï¼ˆç«¯å£ï¼š25ï¼‰ |
| ã€21cn.comã€‘ | pop.21cn.comï¼ˆç«¯å£ï¼š110ï¼‰ | smtp.21cn.comï¼ˆç«¯å£ï¼š25ï¼‰ |
| ã€Foxmailã€‘ | POP.foxmail.comï¼ˆç«¯å£ï¼š110ï¼‰ | SMTP.foxmail.comï¼ˆç«¯å£ï¼š25ï¼‰ |
| ã€china.comã€‘ | pop.china.comï¼ˆç«¯å£ï¼š110ï¼‰ | smtp.china.comï¼ˆç«¯å£ï¼š25ï¼‰ |
| ã€tom.comã€‘ | pop.tom.comï¼ˆç«¯å£ï¼š110ï¼‰ | smtp.tom.comï¼ˆç«¯å£ï¼š25ï¼‰ |

æç¤º

Admin.NET å…¨å±€å¼‚å¸¸æ—¥å¿—é»˜è®¤å¯åŠ¨å‘é€åˆ°æŒ‡å®šé‚®ç®±ã€‚å¼€å…³ç”±ç³»ç»Ÿå‚æ•°é…ç½®å…³é”®å­— `CommonConst.SysErrorMail` æ¥æ§åˆ¶ã€‚

## [é…ç½®æ–‡ä»¶](https://adminnet.top/frontendbook/introduce.html#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6)

é‚®ç®±é…ç½®æ–‡ä»¶ [Configuration/Email.json](https://gitee.com/zuohuaijun/Admin.NET/blob/next/Admin.NET/Admin.NET.Application/Configuration/Email.json)

```
{
  "$schema": "https://gitee.com/dotnetchina/Furion/raw/v4/schemas/v4/furion-schema.json",

  "Email": {
    "Host": "smtp.163.com", // ä¸»æœº
    "Port": 465, // ç«¯å£ 465ã€994ã€25
    "EnableSsl": true, // å¯ç”¨SSL
    "DefaultFromEmail": "xxx@163.com", // é»˜è®¤å‘ä»¶è€…é‚®ç®±
    "DefaultToEmail": "xxx@qq.com", // é»˜è®¤æ¥æ”¶äººé‚®ç®±
    "UserName": "xxx@163.com", // é‚®ç®±è´¦å·
    "Password": "", // é‚®ç®±æˆæƒç 
    "DefaultFromName": "Admin.NET é€šç”¨æƒé™å¼€å‘å¹³å°" // é»˜è®¤é‚®ä»¶æ ‡é¢˜
  }
}
```

## [ç³»ç»Ÿå®ç°](https://adminnet.top/frontendbook/introduce.html#%E7%B3%BB%E7%BB%9F%E5%AE%9E%E7%8E%B0)

```
public class SysEmailService : IDynamicApiController, ITransient
{
    private readonly EmailOptions _emailOptions;

    public SysEmailService(IOptions<EmailOptions> emailOptions)
    {
        _emailOptions = emailOptions.Value;
    }

    /// <summary>
    /// å‘é€é‚®ä»¶ ğŸ“§
    /// </summary>
    /// <param name="content"></param>
    /// <param name="title"></param>
    /// <returns></returns>
    [DisplayName("å‘é€é‚®ä»¶")]
    public async Task SendEmail([Required] string content, string title = "Admin.NET ç³»ç»Ÿé‚®ä»¶")
    {
        var message = new MimeMessage();
        message.From.Add(new MailboxAddress(_emailOptions.DefaultFromEmail, _emailOptions.DefaultFromEmail));
        message.To.Add(new MailboxAddress(_emailOptions.DefaultToEmail, _emailOptions.DefaultToEmail));
        message.Subject = title;
        message.Body = new TextPart("html")
        {
            Text = content
        };

        using var client = new SmtpClient();
        client.Connect(_emailOptions.Host, _emailOptions.Port, _emailOptions.EnableSsl);
        client.Authenticate(_emailOptions.UserName, _emailOptions.Password);
        client.Send(message);
        client.Disconnect(true);

        await Task.CompletedTask;
    }
}
```

## [ä½¿ç”¨æ–¹å¼](https://adminnet.top/frontendbook/introduce.html#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F)

é¦–å…ˆæ³¨å…¥é‚®ä»¶æœåŠ¡ `SysEmailService`ï¼Œç„¶åè°ƒç”¨æ–¹æ³• `SendEmail` å³å¯ï¼Œé‚®ä»¶å†…å®¹é»˜è®¤ HTML æ ¼å¼ã€‚å»ºè®®å‘é€é‚®ä»¶ã€çŸ­ä¿¡ç­‰æ¶ˆæ¯æé†’æ—¶é‡‡ç”¨äº‹ä»¶æ€»çº¿æ¨¡å¼ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹è¿è¡Œã€‚

## [é‚®ä»¶æ¨¡æ¿](https://adminnet.top/frontendbook/introduce.html#%E9%82%AE%E4%BB%B6%E6%A8%A1%E6%9D%BF)

```
[EventSubscribe("Mail:SendOrderMail")]
public async Task SendOrderMail(EventHandlerExecutingContext context)
{
    // var orderId = (long)context.Source.Payload; // ä»äº‹ä»¶æ€»çº¿ä¼ è¿‡æ¥çš„å€¼

    var mailTempPath = Path.Combine(App.WebHostEnvironment.WebRootPath, "Temp\\ErrorMail.tp");
    var mailTemp = File.ReadAllText(mailTempPath);
    var mail = await _serviceScope.ServiceProvider.GetRequiredService<IViewEngine>().RunCompileFromCachedAsync(mailTemp, æ•°æ®å†…å®¹);

    var title = "Admin.NET ç³»ç»Ÿå¼‚å¸¸";
    await _serviceScope.ServiceProvider.GetRequiredService<SysEmailService>().SendEmail(mail, title);
}
```

ä¸‹é¢æ˜¯ä¸€ä¸ª HTML é‚®ä»¶æ¨¡æ¿ï¼Œç›´æ¥é‡‡ç”¨è§†å›¾æ¨¡æ¿å¼•æ“ IViewEngine è‡ªåŠ¨æ›¿æ¢æ¨¡æ¿æ•°æ®ã€‚

```
<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>è®¢å•é‚®ä»¶æ¨¡æ¿</title>
    <style>
        .byTable {
            width: 100%;
            border-collapse: collapse;
            padding: 2px;
        }

        .byTable, .byTable tr th, .byTable tr td {
            border: 1px solid black;
            padding: 5px 15px;
            font-size: 16px;
            }

        .tdbg1 {
            background-color: #EEEEEE;
            font-weight: 700;
        }

        .tdbg2 {
            background-color: #EEEEEE;
        }

        .tdbg3 {
            font-weight: 700;
        }
    </style>
</head>
<body>
    <h4>è®¢å•è¯¦æƒ…</h4>
    <table class="byTable">
        <tr>
            <td class="tdbg1">è®¢å•å·</td>
            <td class="tdbg2">@Model.OrderId</td>
            <td class="tdbg1">é”€å”®å•†å•å·</td>
            <td class="tdbg2">@Model.SellerOrderId</td>
            <td class="tdbg1">ä¾›åº”å•†å•å·</td>
            <td class="tdbg2">@Model.SupplierOrderId</td>
        </tr>
        <tr>
            <td class="tdbg1">è®¢å•æ—¶é—´</td>
            <td class="tdbg2">@Model.OrderTime</td>
            <td class="tdbg1">å…¥ä½æ—¥æœŸ</td>
            <td class="tdbg2">@Model.CheckInTime</td>
            <td class="tdbg1">ç¦»åº—æ—¥æœŸ</td>
            <td class="tdbg2">@Model.CheckOutTime</td>
        </tr>
        <tr>
            <td class="tdbg1">é¢„å®šäººå‘˜</td>
            <td class="tdbg2">@Model.Booker</td>
            <td class="tdbg1">æ‰‹æœºå·ç </td>
            <td class="tdbg2">@Model.Phone</td>
            <td class="tdbg1">æˆ¿é—´æ•°é‡</td>
            <td class="tdbg2">@Model.Rooms</td>
        </tr>
        <tr></tr>
        <tr>
            <td class="tdbg3">é”€å”®å•†åç§°</td>
            <td>@Model.SellerName</td>
            <td class="tdbg3">åŸºç¡€é…’åº—åç§°</td>
            <td>@Model.BaseHotelName</td>
            <td class="tdbg3">åŸºç¡€æˆ¿å‹ç¼–ç </td>
            <td>@Model.BaseRoomCode</td>
        </tr>
        <tr>
            <td class="tdbg3">é”€å”®å•†é…’åº—åœ°å€</td>
            <td colspan="5">@Model.SellerHotelAddress</td>
        </tr>
        <tr>
            <td class="tdbg3">ä¾›åº”å•†åç§°</td>
            <td>@Model.SupplierName</td>
            <td class="tdbg3">ä¾›åº”å•†é…’åº—åç§°</td>
            <td>@Model.SupplierHotelName</td>
            <td class="tdbg3">ä¾›åº”å•†æˆ¿å‹ç¼–ç </td>
            <td>@Model.SupplierRoomCode</td>
        </tr>
        <tr>
            <td class="tdbg3">ä¾›åº”å•†é…’åº—åœ°å€</td>
            <td colspan="5">@Model.SupplierHotelAddress</td>
        </tr>
        <tr></tr>
        <tr>
            <td class="tdbg3">ä¾›åº”å•†é¤é¥®ç±»å‹</td>
            <td>@Model.SupplierBreakfastBoardCode</td>
            <td class="tdbg3">ä¾›åº”å•†é¤é¥®æ•°é‡</td>
            <td>@Model.SupplierBreakfastCount</td>
            <td></td>
            <td></td>
        </tr>
    </table>
</body>
</html>
```