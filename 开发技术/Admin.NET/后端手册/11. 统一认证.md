1.  [é¡¹ç›®ä¸»é¡µ](https://adminnet.top/)
2.  [Backendbook](https://adminnet.top/backendbook/)
3.  [11\. ç»Ÿä¸€è®¤è¯](https://adminnet.top/backendbook/oauth.html)

é…ç½®æ–‡ä»¶ [OAuth.json](https://gitee.com/zuohuaijun/Admin.NET/blob/next/Admin.NET/Admin.NET.Application/Configuration/OAuth.json)ï¼Œæ¯ä¸ªå¹³å°çš„ `ClientId`ã€`ClientSecret`è¯·è‡ªè¡Œå¡«å†™ï¼Œå¹¶æ ¹æ®éƒ¨ç½²åœ°å€ï¼Œå¡«å†™æŒ‡å®šçš„ç™»å½•å›è°ƒåœ°å€ã€‚

```
{
  "$schema": "https://gitee.com/dotnetchina/Furion/raw/v4/schemas/v4/furion-schema.json",

  "OAuth": {
    "Weixin": {
      "ClientId": "xxx",
      "ClientSecret": "xxx"
    },
    "Gitee": {
      "ClientId": "xxx",
      "ClientSecret": "xxx"
    }
  }
}
```

ç»Ÿä¸€æˆæƒç¬¬ä¸‰æ–¹ç™»å½•çš„æ—¶å€™ï¼Œåœ¨ç™»å½•å›è°ƒåœ°å€é‡Œé¢å¤„ç†ç™»å½•æƒé™é€»è¾‘ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºè´¦å·åŠé»˜è®¤åˆ†é…è§’è‰²æƒé™ï¼Œç³»ç»Ÿè¡¨ `SysOAuthUser` å­˜å‚¨ä¸‰æ–¹è´¦å·ç›¸å…³ï¼Œç³»ç»Ÿè´¦å·è¡¨ `SysUser` åˆ™ä¿å­˜å…¶å¯¹åº”ç³»ç»Ÿè´¦å·ä¿¡æ¯ã€‚è‹¥å·²å­˜åœ¨åˆ™ç›´æ¥è¿›è¡Œç³»ç»Ÿç™»å½•ã€‚å…·ä½“å®ç°ç±»è§ [SysOAuthService.cs](https://gitee.com/zuohuaijun/Admin.NET/blob/next/Admin.NET/Admin.NET.Core/Service/OAuth/SysOAuthService.cs) ï¼Œæ­¤æ—¶å‰ç«¯ç™»å½•ä¼šæ ¹æ® `/login?token={token.AccessToken}` è¿›è¡Œè·¯ç”±å‚æ•°è§£æ Tokenã€‚

```
using Microsoft.AspNetCore.Authentication;
using System.Security.Claims;

namespace Admin.NET.Core.Service;

/// <summary>
/// ç³»ç»ŸOAuthæœåŠ¡ ğŸ§©
/// </summary>
[AllowAnonymous]
[ApiDescriptionSettings(Order = 498)]
public class SysOAuthService : IDynamicApiController, ITransient
{
    private readonly IHttpContextAccessor _httpContextAccessor;
    private readonly SqlSugarRepository<SysOAuthUser> _sysOAuthUserRep;

    public SysOAuthService(IHttpContextAccessor httpContextAccessor,
        SqlSugarRepository<SysOAuthUser> sysOAuthUserRep)
    {
        _httpContextAccessor = httpContextAccessor;
        _sysOAuthUserRep = sysOAuthUserRep;
    }

    /// <summary>
    /// ç¬¬ä¸‰æ–¹ç™»å½• ğŸ”–
    /// </summary>
    /// <param name="provider"></param>
    /// <param name="redirectUrl"></param>
    /// <returns></returns>
    [ApiDescriptionSettings(Name = "SignIn"), HttpGet]
    [DisplayName("ç¬¬ä¸‰æ–¹ç™»å½•")]
    public virtual async Task<IActionResult> SignIn([FromQuery] string provider, [FromQuery] string redirectUrl)
    {
        if (string.IsNullOrWhiteSpace(provider) || !await _httpContextAccessor.HttpContext.IsProviderSupportedAsync(provider))
            throw Oops.Oh("ä¸æ”¯æŒçš„OAuthç±»å‹");

        var request = _httpContextAccessor.HttpContext.Request;
        var url = $"{request.Scheme}://{request.Host}{request.PathBase}{request.Path}Callback?provider={provider}&redirectUrl={redirectUrl}";
        var properties = new AuthenticationProperties { RedirectUri = url };
        properties.Items["LoginProvider"] = provider;
        return await Task.FromResult(new ChallengeResult(provider, properties));
    }

    /// <summary>
    /// æˆæƒå›è°ƒ ğŸ”–
    /// </summary>
    /// <param name="provider"></param>
    /// <param name="redirectUrl"></param>
    /// <returns></returns>
    [ApiDescriptionSettings(Name = "SignInCallback"), HttpGet]
    [DisplayName("æˆæƒå›è°ƒ")]
    public virtual async Task<IActionResult> SignInCallback([FromQuery] string provider = null, [FromQuery] string redirectUrl = "")
    {
        if (string.IsNullOrWhiteSpace(provider) || !await _httpContextAccessor.HttpContext.IsProviderSupportedAsync(provider))
            throw Oops.Oh("ä¸æ”¯æŒçš„OAuthç±»å‹");

        var authenticateResult = await _httpContextAccessor.HttpContext.AuthenticateAsync(provider);
        if (!authenticateResult.Succeeded)
            throw Oops.Oh("æˆæƒå¤±è´¥");

        var openIdClaim = authenticateResult.Principal.FindFirst(ClaimTypes.NameIdentifier);
        if (openIdClaim == null || string.IsNullOrWhiteSpace(openIdClaim.Value))
            throw Oops.Oh("æˆæƒå¤±è´¥");

        var name = authenticateResult.Principal.FindFirst(ClaimTypes.Name)?.Value;
        var email = authenticateResult.Principal.FindFirst(ClaimTypes.Email)?.Value;
        var mobilePhone = authenticateResult.Principal.FindFirst(ClaimTypes.MobilePhone)?.Value;
        var dateOfBirth = authenticateResult.Principal.FindFirst(ClaimTypes.DateOfBirth)?.Value;
        var gender = authenticateResult.Principal.FindFirst(ClaimTypes.Gender)?.Value;
        var avatarUrl = "";

        var platformType = PlatformTypeEnum.å¾®ä¿¡å…¬ä¼—å·;
        if (provider == "Gitee")
        {
            platformType = PlatformTypeEnum.Gitee;
            avatarUrl = authenticateResult.Principal.FindFirst(OAuthClaim.GiteeAvatarUrl)?.Value;
        }

        // è‹¥è´¦å·ä¸å­˜åœ¨åˆ™æ–°å»º
        var wechatUser = await _sysOAuthUserRep.AsQueryable().Includes(u => u.SysUser).ClearFilter().FirstAsync(u => u.OpenId == openIdClaim.Value);
        if (wechatUser == null)
        {
            var userId = await App.GetRequiredService<SysUserService>().AddUser(new AddUserInput()
            {
                Account = name,
                RealName = name,
                NickName = name,
                Email = email,
                Avatar = avatarUrl,
                Phone = mobilePhone,
                OrgId = 1300000000101, // æ ¹ç»„ç»‡æ¶æ„
                RoleIdList = new List<long> { 1300000000104 } // ä»…æœ¬äººæ•°æ®è§’è‰²
            });

            await _sysOAuthUserRep.InsertAsync(new SysOAuthUser()
            {
                UserId = userId,
                OpenId = openIdClaim.Value,
                Avatar = avatarUrl,
                NickName = name,
                PlatformType = platformType
            });

            wechatUser = await _sysOAuthUserRep.AsQueryable().Includes(u => u.SysUser).ClearFilter().FirstAsync(u => u.OpenId == openIdClaim.Value);
        }

        // æ„å»ºTokenä»¤ç‰Œ
        var token = await App.GetRequiredService<SysAuthService>().CreateToken(wechatUser.SysUser);

        return new RedirectResult($"{redirectUrl}/#/login?token={token.AccessToken}");
    }
}
```

[

ä¸Šä¸€é¡µ

7\. æ¨¡æ¿æ‰“å°

](https://adminnet.top/backendbook/templateprint.html)[

ä¸‹ä¸€é¡µ

9\. æ•°æ®æƒé™

](https://adminnet.top/backendbook/permission.html)