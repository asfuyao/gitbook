åç«¯æ‰‹å†Œä»¤ç‰ŒTokenå¤§çº¦ 4 åˆ†é’Ÿçº¦ 1281 å­—

___

æç¤º

Admin.NET é‡‡ç”¨ Token é‰´æƒï¼Œå¹¶ä¸”æ˜¯åŒä»¤ç‰Œæ¨¡å¼ã€‚è®¿é—® AccessToken å’Œåˆ·æ–° RefreshTokenï¼ŒAccessToken è¿‡æœŸåï¼Œç³»ç»Ÿä¼šæ ¹æ®åˆ·æ–° RefreshToken å»æœåŠ¡å™¨æ¢æ–°çš„ AccessTokenï¼Œå‰ç«¯æ›´æ–°ä¿å­˜ Token å¯ä»¥ç»§ç»­è®¿é—®æ¥å£ã€‚

å¦‚æœéœ€è¦å¯¹ç‰¹å®šçš„ Action æˆ– Controller å…è®¸åŒ¿åè®¿é—®ï¼Œåˆ™åªéœ€è¦è´´ `[AllowAnonymous]` å³å¯ã€‚

åŒæ—¶ï¼ŒAdmin.NET å·²ç»å®ç°äº†å½“å‰ç”¨æˆ·ç®¡ç†æœåŠ¡ç±»ï¼Œç›´æ¥æ³¨å…¥åˆ™å¯ä»¥ç›´æ¥è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„åç§°ã€ç”¨æˆ·Idç­‰ä¿¡æ¯ï¼Œæ— éœ€å†æ ¹æ® Token æ‰‹åŠ¨è§£æã€‚ç›´æ¥æ‹¿åˆ°å½“å‰è®¿é—®ç”¨æˆ·Idï¼Œå¯æ–¹ä¾¿å¤„ç†å…·ä½“ä¸šåŠ¡é€»è¾‘ã€‚

JWT é…ç½®æ–‡ä»¶å¦‚ä¸‹ [Configuration/JWT.json](https://gitee.com/zuohuaijun/Admin.NET/blob/next/Admin.NET/Admin.NET.Application/Configuration/JWT.json)ï¼Œè®°å¾—æ›´æ¢å¯†é’¥ä¸²ï¼Œé˜²æ­¢å¤šä¸ªç³»ç»Ÿä¸€æ ·ï¼Œé€ æˆè´¦å·å®‰å…¨äº‹æ•…ã€‚å¯†åŒ™ä¸²å»ºè®®ç›´æ¥ç”¨32ä½é•¿åº¦çš„MD5ä¸²ã€‚.NET8 æ—¶æ‰€éœ€è¦çš„å­—ç¬¦ä¸²é•¿åº¦æ›´é•¿ï¼Œå°±å†å¤åˆ¶ä¸€ä»½ã€‚

```
{
  "$schema": "https://gitee.com/dotnetchina/Furion/raw/v4/schemas/v4/furion-schema.json",

  "JWTSettings": {
    "ValidateIssuerSigningKey": true, // æ˜¯å¦éªŒè¯å¯†é’¥ï¼Œbool ç±»å‹ï¼Œé»˜è®¤true
    "IssuerSigningKey": "3c1cbc3f546eda35168c3aa3cb91780fbe703f0996c6d123ea96dc85c70bbc0a", // å¯†é’¥ï¼Œstring ç±»å‹ï¼Œå¿…é¡»æ˜¯å¤æ‚å¯†é’¥ï¼Œé•¿åº¦å¤§äº16
    "ValidateIssuer": true, // æ˜¯å¦éªŒè¯ç­¾å‘æ–¹ï¼Œbool ç±»å‹ï¼Œé»˜è®¤true
    "ValidIssuer": "Admin.NET", // ç­¾å‘æ–¹ï¼Œstring ç±»å‹
    "ValidateAudience": true, // æ˜¯å¦éªŒè¯ç­¾æ”¶æ–¹ï¼Œbool ç±»å‹ï¼Œé»˜è®¤true
    "ValidAudience": "Admin.NET", // ç­¾æ”¶æ–¹ï¼Œstring ç±»å‹
    "ValidateLifetime": true, // æ˜¯å¦éªŒè¯è¿‡æœŸæ—¶é—´ï¼Œbool ç±»å‹ï¼Œé»˜è®¤trueï¼Œå»ºè®®true
    //"ExpiredTime": 20, // è¿‡æœŸæ—¶é—´ï¼Œlong ç±»å‹ï¼Œå•ä½åˆ†é’Ÿï¼Œé»˜è®¤20åˆ†é’Ÿï¼Œæœ€å¤§æ”¯æŒ 13 å¹´
    "ClockSkew": 5, // è¿‡æœŸæ—¶é—´å®¹é”™å€¼ï¼Œlong ç±»å‹ï¼Œå•ä½ç§’ï¼Œé»˜è®¤5ç§’
    "Algorithm": "HS256", // åŠ å¯†ç®—æ³•ï¼Œstring ç±»å‹ï¼Œé»˜è®¤ HS256
    "RequireExpirationTime": true // éªŒè¯è¿‡æœŸæ—¶é—´ï¼Œè®¾ç½® false å°†æ°¸ä¸è¿‡æœŸ
  }
}
```

Algorithm åŠ å¯†ç®—æ³•

-   HS256
-   HS384
-   HS512
-   PS256
-   PS384
-   PS512
-   ES256
-   ES256K
-   ES384
-   ES512
-   EdDSA

å…·ä½“å¯å‚è€ƒ [SecurityAlgorithms](https://github.com/AzureAD/azure-activedirectory-identitymodel-extensions-for-dotnet/blob/dev/src/Microsoft.IdentityModel.Tokens/SecurityAlgorithms.cs)

Token é»˜è®¤è¿‡æœŸæ—¶é—´ä¸º 7 å¤©ï¼Œåœ¨ç³»ç»Ÿå‚æ•°é…ç½®é‡Œé¢å¯è‡ªè¡Œä¿®æ”¹ã€‚

å½“å‰ç™»å½•ç”¨æˆ·ç®¡ç†æœåŠ¡ç±» [Admin.NET.Core/Service/User/UserManager.cs](https://gitee.com/zuohuaijun/Admin.NET/blob/next/Admin.NET/Admin.NET.Core/Service/User/UserManager.cs) å®ç°å¦‚ä¸‹ï¼š

```
namespace Admin.NET.Core;

/// <summary>
/// å½“å‰ç™»å½•ç”¨æˆ·
/// </summary>
public class UserManager : IScoped
{
    private readonly IHttpContextAccessor _httpContextAccessor;

    /// <summary>
    /// ç”¨æˆ·ID
    /// </summary>
    public long UserId => (_httpContextAccessor.HttpContext?.User.FindFirst(ClaimConst.UserId)?.Value).ToLong();

    /// <summary>
    /// ç§Ÿæˆ·ID
    /// </summary>
    public long TenantId => (_httpContextAccessor.HttpContext?.User.FindFirst(ClaimConst.TenantId)?.Value).ToLong();

    /// <summary>
    /// ç”¨æˆ·è´¦å·
    /// </summary>
    public string Account => _httpContextAccessor.HttpContext?.User.FindFirst(ClaimConst.Account)?.Value;

    /// <summary>
    /// çœŸå®å§“å
    /// </summary>
    public string RealName => _httpContextAccessor.HttpContext?.User.FindFirst(ClaimConst.RealName)?.Value;

    /// <summary>
    /// æ˜¯å¦è¶…çº§ç®¡ç†å‘˜
    /// </summary>
    public bool SuperAdmin => _httpContextAccessor.HttpContext?.User.FindFirst(ClaimConst.AccountType)?.Value == ((int)AccountTypeEnum.SuperAdmin).ToString();

    /// <summary>
    /// æ˜¯å¦ç³»ç»Ÿç®¡ç†å‘˜
    /// </summary>
    public bool SysAdmin => _httpContextAccessor.HttpContext?.User.FindFirst(ClaimConst.AccountType)?.Value == ((int)AccountTypeEnum.SysAdmin).ToString();

    /// <summary>
    /// ç»„ç»‡æœºæ„Id
    /// </summary>
    public long OrgId => (_httpContextAccessor.HttpContext?.User.FindFirst(ClaimConst.OrgId)?.Value).ToLong();

    /// <summary>
    /// å¾®ä¿¡OpenId
    /// </summary>
    public string OpenId => _httpContextAccessor.HttpContext?.User.FindFirst(ClaimConst.OpenId)?.Value;

    public UserManager(IHttpContextAccessor httpContextAccessor)
    {
        _httpContextAccessor = httpContextAccessor;
    }
}
```

token

åˆ›å»º Token ç¤ºä¾‹ï¼š

```
    /// <summary>
    /// ç”ŸæˆTokenä»¤ç‰Œ ğŸ”–
    /// </summary>
    /// <param name="user"></param>
    /// <returns></returns>
    [NonAction]
    public virtual async Task<LoginOutput> CreateToken(SysUser user)
    {
        // å•ç”¨æˆ·ç™»å½•
        await _sysOnlineUserService.SingleLogin(user.Id);

        // ç”ŸæˆTokenä»¤ç‰Œ
        var tokenExpire = await _sysConfigService.GetTokenExpire();
        var accessToken = JWTEncryption.Encrypt(new Dictionary<string, object>
        {
            { ClaimConst.UserId, user.Id },
            { ClaimConst.TenantId, user.TenantId },
            { ClaimConst.Account, user.Account },
            { ClaimConst.RealName, user.RealName },
            { ClaimConst.AccountType, user.AccountType },
            { ClaimConst.OrgId, user.OrgId },
            { ClaimConst.OrgName, user.SysOrg?.Name },
            { ClaimConst.OrgType, user.SysOrg?.Type },
        }, tokenExpire);

        // ç”Ÿæˆåˆ·æ–°Tokenä»¤ç‰Œ
        var refreshTokenExpire = await _sysConfigService.GetRefreshTokenExpire();
        var refreshToken = JWTEncryption.GenerateRefreshToken(accessToken, refreshTokenExpire);

        // è®¾ç½®å“åº”æŠ¥æ–‡å¤´
        _httpContextAccessor.HttpContext.SetTokensOfResponseHeaders(accessToken, refreshToken);

        // Swagger Knife4UI-AfterScriptç™»å½•è„šæœ¬
        // ke.global.setAllHeader('Authorization', 'Bearer ' + ke.response.headers['access-token']);

        return new LoginOutput
        {
            AccessToken = accessToken,
            RefreshToken = refreshToken
        };
    }
```

**åç«¯æˆæƒ** å®ç°ï¼Œè‡ªåŠ¨éªŒè¯ã€åˆ·æ–° Token [Admin.NET.Web.Core/Handlers/JwtHandler.cs](https://gitee.com/zuohuaijun/Admin.NET/blob/next/Admin.NET/Admin.NET.Web.Core/Handlers/JwtHandler.cs)

```
using Admin.NET.Core;
using Admin.NET.Core.Service;
using Furion;
using Furion.Authorization;
using Furion.DataEncryption;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.DependencyInjection;
using System;
using System.Threading.Tasks;

namespace Admin.NET.Web.Core
{
    public class JwtHandler : AppAuthorizeHandler
    {
        private readonly IServiceProvider _serviceProvider;

        public JwtHandler(IServiceProvider serviceProvider)
        {
            _serviceProvider = serviceProvider;
        }

        /// <summary>
        /// è‡ªåŠ¨åˆ·æ–°Token
        /// </summary>
        /// <param name="context"></param>
        /// <param name="httpContext"></param>
        /// <returns></returns>
        public override async Task HandleAsync(AuthorizationHandlerContext context, DefaultHttpContext httpContext)
        {
            // var serviceProvider = context.GetCurrentHttpContext().RequestServices;
            using var serviceScope = _serviceProvider.CreateScope();

            // è‹¥å½“å‰è´¦å·å­˜åœ¨é»‘åå•ä¸­åˆ™æˆæƒå¤±è´¥
            var sysCacheService = serviceScope.ServiceProvider.GetRequiredService<SysCacheService>();
            if (sysCacheService.ExistKey($"{CacheConst.KeyBlacklist}{context.User.FindFirst(ClaimConst.UserId)?.Value}"))
            {
                context.Fail();
                context.GetCurrentHttpContext().SignoutToSwagger();
                return;
            }

            var sysConfigService = serviceScope.ServiceProvider.GetRequiredService<SysConfigService>();
            var tokenExpire = await sysConfigService.GetTokenExpire();
            var refreshTokenExpire = await sysConfigService.GetRefreshTokenExpire();
            if (JWTEncryption.AutoRefreshToken(context, context.GetCurrentHttpContext(), tokenExpire, refreshTokenExpire))
            {
                await AuthorizeHandleAsync(context);
            }
            else
            {
                context.Fail(); // æˆæƒå¤±è´¥
                var currentHttpContext = context.GetCurrentHttpContext();
                if (currentHttpContext == null)
                    return;
                // è·³è¿‡ç”±äº SignatureAuthentication å¼•å‘çš„å¤±è´¥
                if (currentHttpContext.Items.ContainsKey(SignatureAuthenticationDefaults.AuthenticateFailMsgKey))
                    return;
                currentHttpContext.SignoutToSwagger();
            }
        }

        public override async Task<bool> PipelineAsync(AuthorizationHandlerContext context, DefaultHttpContext httpContext)
        {
            // å·²è‡ªåŠ¨éªŒè¯ Jwt Token æœ‰æ•ˆæ€§
            return await CheckAuthorizeAsync(httpContext);
        }

        /// <summary>
        /// æƒé™æ ¡éªŒæ ¸å¿ƒé€»è¾‘
        /// </summary>
        /// <param name="httpContext"></param>
        /// <returns></returns>
        private static async Task<bool> CheckAuthorizeAsync(DefaultHttpContext httpContext)
        {
            // æ’é™¤è¶…ç®¡æƒé™
            if (App.User.FindFirst(ClaimConst.AccountType)?.Value == ((int)AccountTypeEnum.SuperAdmin).ToString())
                return true;

            // æ¥å£è·¯ç”±æƒé™
            var path = httpContext.Request.Path.ToString();
            var apis = await App.GetRequiredService<SysRoleService>().GetUserApiList();
            return apis.Exists(u => path.Contains(u, StringComparison.CurrentCulture));
        }
    }
}
```

å‰ç«¯é€šè¿‡ [Web/src/utils/axios-utils.ts](https://gitee.com/zuohuaijun/Admin.NET/blob/next/Web/src/utils/axios-utils.ts) è‡ªåŠ¨è§£æ Tokenï¼Œè®¿é—®è‡ªåŠ¨å¸¦ä¸Š Tokenï¼Œè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦è¿‡æœŸã€ç”¨åˆ·æ–° Token å»æ¢æ–° Tokenã€æ›´æ–°æœ¬åœ° Token éƒ½æ˜¯è‡ªåŠ¨åŒ–ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†ã€‚

```
/**
 * è§£å¯† JWT token çš„ä¿¡æ¯
 * @param token jwt token å­—ç¬¦ä¸²
 * @returns <any>object
 */
export function decryptJWT(token: string): any {
 token = token.replace(/_/g, '/').replace(/-/g, '+');
 var json = decodeURIComponent(escape(window.atob(token.split('.')[1])));
 return JSON.parse(json);
}
```