<!-- TOC -->

- [1. 游标的使用](#1-游标的使用)
    - [1.1. 游标概念](#11-游标概念)
        - [1.1.1. 处理显式游标](#111-处理显式游标)
            - [1.1.1.1. 定义/声明游标](#1111-定义声明游标)
            - [1.1.1.2. 打开游标](#1112-打开游标)
            - [1.1.1.3. 提取游标数据](#1113-提取游标数据)
            - [1.1.1.4. 对该记录进行处理](#1114-对该记录进行处理)
            - [1.1.1.5. 继续处理，直到活动集合中没有记录](#1115-继续处理直到活动集合中没有记录)
            - [1.1.1.6. 关闭游标](#1116-关闭游标)

<!-- /TOC -->

# 1. 游标的使用

在 PL/SQL 程序中，对于处理多行记录的事务经常使用游标来实现。

## 1.1. 游标概念

&emsp;&emsp;在PL/SQL块中执行SELECT、INSERT、DELETE和UPDATE语句时，ORACLE会在内存中为其分配上下文区（Context Area），即缓冲区。游标是指向该区的一个指针，或是命名一个工作区（Work Area），或是一种结构化数据类型。它为应用等量齐观提供了一种对具有多行数据查询结果集中的每一行数据分别进行单独处理的方法，是设计嵌入式SQL语句的应用程序的常用编程方式。

&emsp;&emsp;在每个用户会话中，可以同时打开多个游标，其数量由数据库初始化参数文件中的OPEN_CURSORS参数定义。

对于不同的SQL语句，游标的使用情况不同：

| SQL语句 | 游标 |
| :------| :------ |
| 非查询语句 | 隐式的 |
| 结果是单行的查询语句 | 隐式的或显示的 |
| 结果是多行的查询语句 | 显示的 |

### 1.1.1. 处理显式游标

&emsp;&emsp;显式游标处理需四个 PL/SQL步骤:

#### 1.1.1.1. 定义/声明游标

&emsp;&emsp;就是定义一个游标名，以及与其相对应的`SELECT`语句。

格式：

```sql
CURSOR cursor_name[(parameter[, parameter]…)]
        [RETURN datatype]
IS
    select_statement;
```

&emsp;&emsp;游标参数只能为输入参数，其格式为：

```sql
parameter_name [IN] datatype [{:= | DEFAULT} expression]
```

&emsp;&emsp;**在指定数据类型时，不能使用长度约束。如**`NUMBER(4),CHAR(10)`**等都是错误的。**

&emsp;&emsp;`[RETURN datatype]`是可选的，表示**游标**返回数据的数据。如果选择，则应该严格与`select_statement`中的选择列表在次序和数据类型上匹配。一般是记录数据类型或带“`%ROWTYPE`”的数据。

#### 1.1.1.2. 打开游标

&emsp;&emsp;就是执行游标所对应的`SELECT`语句，将其查询结果放入工作区，并且指针指向工作区的首部，标识游标结果集合。如果游标查询语句中带有`FOR UPDATE`选项，`OPEN`语句还将锁定数据库表中游标结果集合对应的数据行。

格式：

```sql
OPEN cursor_name[([parameter =>] value[, [parameter =>] value]…)];
```

&emsp;&emsp;在向游标传递参数时，可以使用与函数参数相同的传值方法，即位置表示法和名称表示法。PL/SQL程序不能用`OPEN`语句重复打开一个游标。

#### 1.1.1.3. 提取游标数据
&emsp;&emsp;就是检索结果集合中的数据行，放入指定的输出变量中。

格式：

```sql
FETCH cursor_name INTO {variable_list | record_variable };
```

&emsp;&emsp;执行FETCH语句时，每次返回一个数据行，然后自动将游标移动指向下一个数据行。当检索到最后一行数据时，如果再次执行`FETCH`语句，将操作失败，并将游标属性`%NOTFOUND`置为`TRUE`。所以每次执行完`FETCH`语句后，检查游标属性`%NOTFOUND`就可以判断`FETCH`语句是否执行成功并返回一个数据行，以便确定是否给对应的变量赋了值。

#### 1.1.1.4. 对该记录进行处理

#### 1.1.1.5. 继续处理，直到活动集合中没有记录

#### 1.1.1.6. 关闭游标

&emsp;&emsp;当提取和处理完游标结果集合数据后，应及时关闭游标，以释放该游标所占用的系统资源，并使该游标的工作区变成无效，不能再使用`FETCH`语句取其中数据。关闭后的游标可以使用`OPEN`语句重新打开。

格式：

```sql
CLOSE cursor_name;
```

**注：定义的游标不能有INTO 子句。**
